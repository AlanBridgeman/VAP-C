FROM node:lts as dependencies
WORKDIR /vap_c_dev
COPY src/package.json src/yarn.lock ./
# Needed for Prisma client generation from what I've read
COPY src/prisma  ./prisma
# Needed configuration file and runtime secret
# For Font Awesome Pro
COPY src/npmrc  ./.npmrc
ARG FONTAWESOME_NPM_AUTH_TOKEN
# Dependencies install
RUN yarn install --frozen-lockfile
# Clean up the custom npm configuration
RUN rm -f .npmrc

FROM node:lts as builder
WORKDIR /vap_c_dev
COPY src/. .
COPY --from=dependencies /vap_c_dev/node_modules ./node_modules
# NOTE: No ARG DATABASE_URL line here
RUN yarn build

FROM node:lts as runner
WORKDIR /vap_c_dev
ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Important as the JavaScript overarching configuration
COPY --from=builder /vap_c_dev/package.json ./package.json
# Prismais a special dependency as the database ORM
COPY --from=builder /vap_c_dev/prisma ./prisma
# Copy the lib and middleware directories over (required for server side stuff)
COPY --from=builder /vap_c_dev/lib ./lib
# Copy over the static asset files
COPY --from=builder /vap_c_dev/public ./public
# Copy over the generated files (optimized pages etc...)
COPY --from=builder --chown=nextjs:nodejs /vap_c_dev/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /vap_c_dev/.next/static ./.next/static
# Because I need modules not included during the next build (inside the 
# .next/standalone/node_modules folder) I want to bring the node_modules 
# folder from the dependency container into this container
COPY --from=dependencies /vap_c_dev/node_modules ./node_modules

# DEPRECIATED: Now generated by startup scripts
#COPY --from=builder /vap_c_dev/.env.local ./.env.local

# Install SQLlite database'
RUN apt-get update \
    && apt-get install -y sqlite3 libsqlite3-dev
RUN mkdir /db
RUN /usr/bin/sqlite3 /db/test.db "VACUUM;"

# Initialization wrapper script (to initialize Prisma for SQLlite before server startup)
COPY startup/. ./startup
RUN chmod u+x ./startup/init.test.sh

# Needed for TypeScript initialization script (init_data.ts)
COPY src/types/. ./types

EXPOSE 3000
CMD ["yarn", "start-test"]